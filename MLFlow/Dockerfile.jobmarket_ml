# ===========================================
# Dockerfile.jobmarket_ml - Container ML optimisé pour jobmarket_ml
# ===========================================

FROM python:3.11.12-slim AS builder

# Arguments de build
ARG PYTHON_VERSION=3.11.12
ARG MLFLOW_VERSION=2.22.0

# Métadonnées
LABEL maintainer="ML Team" \
  description="Container optimisé pour jobmarket_ml" \
  version="1.0"

# Installation des dépendances système essentielles et création de l'environnement Python
RUN apt-get update && apt-get install -y --no-install-recommends \
  gcc \
  g++ \
  git \
  make \
  python3-dev && \
  python -m venv /opt/venv && \
  . /opt/venv/bin/activate && \
  pip install --no-cache-dir --upgrade pip setuptools wheel && \
  apt-get purge -y --auto-remove gcc g++ make python3-dev && \
  apt-get clean && \
  rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# ===========================================
# Image finale
# ===========================================
FROM python:3.11.12-slim

# Variables d'environnement
ENV PYTHONUNBUFFERED=1 \
  PYTHONDONTWRITEBYTECODE=1 \
  PATH="/opt/venv/bin:$PATH" \
  MLFLOW_TRACKING_URI=http://mlflow-tracking:5000 \
  MLFLOW_EXPERIMENT_NAME=jobmarket_matching \
  MLFLOW_ARTIFACT_ROOT=/app/mlruns \
  TRAINING_LOG_LEVEL=INFO \
  TRANSFORMERS_CACHE=/app/cache/transformers \
  HF_HOME=/app/cache/huggingface \
  MPLCONFIGDIR=/app/cache/matplotlib \
  SKLEARN_CACHE_DIR=/app/cache/sklearn \
  TMPDIR=/app/temp

# Installation des dépendances système et configuration initiale (en tant que root)
RUN apt-get update && apt-get install -y --no-install-recommends \
  git \
  curl && \
  rm -rf /var/lib/apt/lists/* && \
  # Création de l'utilisateur et du groupe
  groupadd -r mluser --gid=1000 && \
  useradd -r -g mluser --uid=1000 -m mluser && \
  # Création de tous les répertoires nécessaires
  mkdir -p /app/{src,data,models,logs,cache,experiments,temp,config,scripts} && \
  mkdir -p /app/cache/{matplotlib,transformers,huggingface,sklearn} && \
  mkdir -p /tmp/mlflow

# Copie des fichiers avec les bonnes permissions
COPY --from=builder /opt/venv /opt/venv
COPY --chown=mluser:mluser jobmarket_ml /app/jobmarket_ml
COPY --chown=mluser:mluser src/train_model.py /app/src/train_model.py
COPY --chown=mluser:mluser src/register_model.py /app/src/register_model.py
COPY --chown=mluser:mluser src/test_model.py /app/src/test_model.py
COPY --chown=mluser:mluser src/serve_model.py /app/src/serve_model.py
COPY --chown=mluser:mluser scripts/ml_entrypoint.sh /app/scripts/

# Configuration finale des permissions (en tant que root)
RUN chmod 755 /app/scripts/ml_entrypoint.sh && \
  chown -R mluser:mluser /app /tmp/mlflow /opt/venv

# Passage à l'utilisateur non privilégié
USER mluser
WORKDIR /app/jobmarket_ml

# Installation du package en tant que mluser
RUN pip install -e .

WORKDIR /app
ENTRYPOINT ["/app/scripts/ml_entrypoint.sh"]
CMD ["help"]
